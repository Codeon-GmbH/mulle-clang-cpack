#! /usr/bin/env bash


VM="${1:-precise}"
VERSION="${2:-8.0.0.0}"

set -x

# https://stackoverflow.com/questions/37453525/how-can-i-check-specific-server-running-or-notusing-virsh-commands-before-i-s
is_vm_running()
{
   local vm="$1"

   local tmp

   tmp=$(virsh list --all | grep " ${vm} " | awk '{ print $3}')
   if [ "x$tmp" == "x" ] || [ "x$tmp" != "xrunning" ]
   then
      return 1
   fi
   return 0
}


start_vm_if_needed()
{
   local vm="$1"
   local user="$2"

   if is_vm_running "${vm}"
   then
      return
   fi

   virsh netstart default 2> /dev/null

   while ! is_vm_running "${vm}"
   do
      sleep 1
      virsh start "${vm}" && break
   done

   while ! ssh "${user}@${vm}" true > /dev/null 2>&1
   do
      sleep 1
   done
}




build_package()
{
   local vm="$1"
   local user="$2"

   local cleanscript

   cleanscript="[ ! -d mulle-clang-lldb ] || rm -rf mulle-clang-lldb"
   ssh "${user}@${vm}" "${cleanscript}" || exit 1


   local preparescript

   preparescript="\
   [ -d cpack-mulle-clang ] || git clone \"mulle-kybernetik.com:/scm/public_git/repositories/cpack-mulle-clang\" &&
   ( cd cpack-mulle-clang && git pull )
   "
   ssh "${user}@${vm}" "${preparescript}" || exit 1

   local buildscript

   buildscript="./cpack-mulle-clang/build \"${VERSION}\""
   ssh "${user}@${vm}" "${buildscript}" || exit 1

   local filename

   filename="mulle-clang-${VERSION}-amd64-${VM}.deb"
   scp "${user}@${vm}:${filename}" "${filename}"
}

start_vm_if_needed "${VM}" "${USER}"
build_package  "${VM}" "${USER}"
